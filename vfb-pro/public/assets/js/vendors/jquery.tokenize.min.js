/**
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * This software consists of voluntary contributions made by many individuals
 * and is licensed under the new BSD license.
 *
 * @author      David Zeller <me@zellerda.com>
 * @license     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 * @version     2.2.1
 */
!function($,e){var t={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,ARROW_UP:38,ARROW_DOWN:40,COMMA:188},n="tokenize";$.tokenize=function(e){void 0==e&&(e=$.fn.tokenize.defaults),this.options=e},$.extend($.tokenize.prototype,{init:function(e){var t=this;this.select=e.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide(),this.container=$("<div />").attr("class",this.select.attr("class")).addClass("Tokenize"),1==this.options.maxElements&&this.container.addClass("OnlyOne"),this.dropdown=$("<ul />").addClass("Dropdown"),this.tokensContainer=$("<ul />").addClass("TokensContainer"),this.searchToken=$("<li />").addClass("TokenSearch").appendTo(this.tokensContainer),this.searchInput=$("<input />").attr("maxlength",this.options.searchMaxLength).appendTo(this.searchToken),this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select),this.tokensContainer.on("click",function(e){e.stopImmediatePropagation(),t.searchInput.get(0).focus(),t.dropdown.is(":hidden")&&""!=t.searchInput.val()&&t.search()}),this.searchInput.on("keydown",function(e){t.resizeSearchInput(),t.keydown(e)}),this.searchInput.on("keyup",function(e){t.keyup(e)}),this.searchInput.on("paste",function(){setTimeout(function(){t.resizeSearchInput()},10),setTimeout(function(){var e=t.searchInput.val().split(",");e.length>1&&$.each(e,function(e,n){t.tokenAdd(n.trim(),"")})},20)}),$(document).on("click",function(){t.dropdownHide(),1==t.options.maxElements&&t.searchInput.val()&&t.tokenAdd(t.searchInput.val(),"")}),this.resizeSearchInput(),$("option:selected",this.select).each(function(){t.tokenAdd($(this).attr("value"),$(this).html(),!0)})},dropdownShow:function(){this.dropdown.show()},dropdownPrev:function(){$("li.Hover",this.dropdown).length>0?$("li.Hover",this.dropdown).is("li:first-child")?($("li.Hover",this.dropdown).removeClass("Hover"),$("li:last-child",this.dropdown).addClass("Hover")):$("li.Hover",this.dropdown).removeClass("Hover").prev().addClass("Hover"):$("li:first",this.dropdown).addClass("Hover")},dropdownNext:function(){$("li.Hover",this.dropdown).length>0?$("li.Hover",this.dropdown).is("li:last-child")?($("li.Hover",this.dropdown).removeClass("Hover"),$("li:first-child",this.dropdown).addClass("Hover")):$("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover"):$("li:first",this.dropdown).addClass("Hover")},dropdownAddItem:function(e,t,n){if(void 0==n&&(n=t),$('li[data-value="'+e+'"]',this.tokensContainer).length)return!1;var o=this,s=$("<li />").attr("data-value",e).attr("data-text",t).html(n).on("click",function(e){e.stopImmediatePropagation(),o.tokenAdd($(this).attr("data-value"),$(this).attr("data-text"))}).on("mouseover",function(){$(this).addClass("Hover")}).on("mouseout",function(){$("li",o.dropdown).removeClass("Hover")});return this.dropdown.append(s),!0},dropdownHide:function(){this.dropdownReset(),this.dropdown.hide()},dropdownReset:function(){this.dropdown.html("")},resizeSearchInput:function(){var e=$("<div />").css({position:"absolute",visibility:"hidden"}).addClass("TokenizeMeasure").html(this.searchInput.val());$("body").append(e),this.searchInput.width(e.width()+25),e.remove()},resetSearchInput:function(){this.searchInput.val(""),this.resizeSearchInput()},resetPendingTokens:function(){$("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keydown:function(e){if(e.keyCode==t.COMMA)e.preventDefault(),this.tokenAdd(this.searchInput.val(),"");else switch(e.keyCode){case t.BACKSPACE:0==this.searchInput.val().length&&(e.preventDefault(),$("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove($("li.Token.PendingDelete").attr("data-value")):$("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());break;case t.TAB:case t.ENTER:if($("li.Hover",this.dropdown).length){var n=$("li.Hover",this.dropdown);e.preventDefault(),this.tokenAdd(n.attr("data-value"),n.attr("data-text"))}else this.searchInput.val()&&(e.preventDefault(),this.tokenAdd(this.searchInput.val(),""));this.resetPendingTokens();break;case t.ESCAPE:this.resetSearchInput(),this.dropdownHide(),this.resetPendingTokens();break;case t.ARROW_UP:e.preventDefault(),this.dropdownPrev();break;case t.ARROW_DOWN:e.preventDefault(),this.dropdownNext();break;default:this.resetPendingTokens()}},keyup:function(e){if(e.keyCode!=this.options.validator)switch(e.keyCode){case t.TAB:case t.ENTER:case t.ESCAPE:case t.ARROW_UP:case t.ARROW_DOWN:break;case t.BACKSPACE:this.searchInput.val()?this.search():this.dropdownHide();break;default:this.searchInput.val()&&this.search()}},search:function(){var e=this,t=1;if(this.options.maxElements>0&&$("li.Token",this.tokensContainer).length>=this.options.maxElements)return!1;if("select"==this.options.datas){var n=!1,o=new RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");this.dropdownReset(),$("option",this.select).not(":selected").each(function(){return t<=e.options.nbDropdownElements?void(o.test($(this).html())&&(e.dropdownAddItem($(this).attr("value"),$(this).html()),n=!0,t++)):!1}),n?($("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else $.ajax({url:this.options.datas,data:this.options.searchParam+"="+this.searchInput.val(),dataType:this.options.dataType,success:function(n){return n&&(e.dropdownReset(),$.each(n,function(n,o){if(!(t<=e.options.nbDropdownElements))return!1;var s=void 0;o[e.options.htmlField]&&(s=o[e.options.htmlField]),e.dropdownAddItem(o[e.options.valueField],o[e.options.textField],s),t++}),$("li",e.dropdown).length)?($("li:first",e.dropdown).addClass("Hover"),e.dropdownShow(),!0):void e.dropdownHide()},error:function(e,t){console.log("Error : "+t)}})},tokenAdd:function(e,t,n){if(void 0==e||""==e)return!1;if((void 0==t||""==t)&&(t=e),void 0==n&&(n=!1),this.options.maxElements>0&&$("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),!1;var o=this,s=$("<a />").addClass("Close").html("&#215;").on("click",function(t){t.stopImmediatePropagation(),o.tokenRemove(e)});if($('option[value="'+e+'"]',this.select).length)$('option[value="'+e+'"]',this.select).attr("selected","selected");else{if(!this.options.newElements)return this.resetSearchInput(),!1;var i=$("<option />").attr("selected","selected").attr("value",e).attr("data-type","custom").html(t);this.select.append(i)}return $('li.Token[data-value="'+e+'"]',this.tokensContainer).length>0?!1:($("<li />").addClass("Token").attr("data-value",e).append("<span>"+t+"</span>").prepend(s).insertBefore(this.searchToken),n||this.options.onAddToken(e,t),this.resetSearchInput(),this.dropdownHide(),!0)},tokenRemove:function(e){var t=$('option[value="'+e+'"]',this.select);"custom"==t.attr("data-type")?t.remove():t.removeAttr("selected"),$('li.Token[data-value="'+e+'"]',this.tokensContainer).remove(),this.options.onRemoveToken(e),this.resizeSearchInput(),this.dropdownHide()}}),$.fn.tokenize=function(e){return void 0==e&&(e={}),this.each(function(){var t=new $.tokenize($.extend({},$.fn.tokenize.defaults,e));t.init($(this)),$(this).data(n,t)}),this},$.fn.tokenize.defaults={datas:"select",searchParam:"search",searchMaxLength:30,newElements:!0,nbDropdownElements:10,maxElements:0,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onAddToken:function(e,t){},onRemoveToken:function(e){}}}(jQuery,"tokenize");